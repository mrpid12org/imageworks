# Model Loader Operations Guide

The ImageWorks model loader provides deterministic model selection for downstream services (chat proxy, CLI tools, GUI) by layering curated metadata with discovered downloads. It exposes CLI utilities, a REST API, and helper services for hash verification and backend activation.

---
## 1. Capabilities Overview

| Capability | Details |
|------------|---------|
| Layered registry | Merges curated (`configs/model_registry.curated.json`) and discovered overlays into `model_registry.json` with caching and hot reload support. |
| Deterministic selection | `service.select_model` resolves logical names to backend URLs using role/capability filters and deployment profile overrides. |
| Hash and lock management | `hashing.verify_model` computes aggregate SHA-256, enforces version locks, and records verification timestamps. |
| Backend orchestration | `cli.activate-model` + `VllmManager` manage single-port vLLM activation; `backend_summary.emit_backend_summary` reports availability. |
| Registry API | FastAPI service exposes `/v1/models`, `/v1/select`, `/v1/verify`, and `/v1/probe/vision` for automation and the GUI. |
| Capability normalisation | Ensures consistent schema across capabilities (vision, reasoning, embeddings, etc.) for CLI, API, and GUI consumption. |
| Integration hooks | Chat proxy, color narrator, personal tagger, and similarity checker resolve logical models via loader utilities. |

---
## 2. Data Model

Each registry entry (`models.RegistryEntry`) includes:
- `backend` (vllm, lmdeploy, ollama, remote, ...)
- `served_model_id` (backend-specific identifier/tag)
- `capabilities` (normalised map: `{"vision": true, "reasoning": false, ...}`)
- `roles` (logical roles: chat, caption, narrator, etc.)
- `version_lock` metadata (expected hash, locked flag, last verified timestamp)
- `artifacts` (download path, aggregate hash, file inventory)
- `probes` (vision probe results)
- `display_name` and `model_aliases` used in GUI tables

Files:
```
configs/
  model_registry.curated.json      # hand-maintained baseline
  model_registry.discovered.json   # generated by downloader/importers
  model_registry.json              # merged snapshot (auto)
```

---
## 3. Interfaces

### 3.1 CLI (`uv run imageworks-models ...`)
| Command | Purpose |
|---------|---------|
| `list [--role ROLE]` | Emit JSON array of logical models with backend, lock status, roles, and hash snippet. |
| `select NAME [--require-vision]` | Resolve NAME to endpoint URL, backend, internal model id, and capabilities. |
| `verify NAME` | Recompute hash, compare against expected, and update `last_verified`. Exits 2 on lock violation. |
| `lock NAME [--set-expected]` / `unlock NAME` | Toggle version lock state, optionally capturing current hash as expectation. |
| `probe-vision NAME IMAGE` | Run quick visual probe using `probe.run_vision_probe`. |
| `metrics [--name NAME]` | Dump aggregate hash/lock info for all or a specific entry. |
| `show-backends [--json-output]` | Summaries of backend endpoints grouped by provider (vLLM, LMDeploy, Ollama). |
| `activate-model NAME [--stop]` | Start or stop the single-port vLLM instance according to registry metadata. |
| `current-model` | Display active vLLM state (`_staging/active_vllm.json`). |

### 3.2 API (`uv run imageworks-models-api`)
| Endpoint | Method | Description |
|----------|--------|-------------|
| `/v1/models` | GET | List logical models with backend, lock, capabilities, and probe hints. |
| `/v1/select` | POST | Resolve model (`{ "name": "chat/default", "require_capabilities": ["vision"] }`). |
| `/v1/verify` | POST | Trigger hash verification (`{ "name": "qwen2-7b" }`). |
| `/v1/probe/vision` | POST | Run probe on supplied `image_path`. |
| `/v1/models/{name}/metrics` | GET | Rolling metrics snapshot (currently sample counts). |

### 3.3 GUI touchpoints
- **Models page**: uses `list`/`select` to show registry table, activate vLLM, and preview backend endpoints.
- **Settings → Backends**: surfaces backend summary, hash states, and version lock toggles via CLI wrappers.
- **Apps (color narrator, personal tagger, similarity checker)**: GUI presets expose “Use registry model” toggles that call loader APIs under the hood.

---
## 4. Configuration

- Registry paths default to `configs/`. Override via env vars consumed by downloader (`IMAGEWORKS_REGISTRY_DIR`).
- Version locks: set `version_lock.locked=true` and `expected_aggregate_sha256` to enforce immutability.
- Probe defaults: `probe.run_vision_probe` uses `configs/vision_probe/prompts.json` (if present) and the chat proxy for inference.
- CLI respects `IMAGEWORKS_INCLUDE_TEST_MODELS=1` to include entries flagged with `testing`. GUI toggles this via settings.

---
## 5. Operational Practices

1. **Onboarding new model**
   - Download via `imageworks-download` or import script (records artifacts + metadata).
   - Edit curated registry entry (backend, roles, capabilities, served id).
   - Run `uv run imageworks-models verify <name>` to capture aggregate hash.
   - Lock entry: `uv run imageworks-models lock <name> --set-expected`.

2. **Refreshing served id / endpoint**
   - Update `served_model_id` and `backend_config` fields.
   - If vLLM, ensure `backend_config.launch` contains command (consult `registry.py`).
   - Restart chat proxy or call `load_registry(force=True)`.

3. **Audit**
   - `uv run imageworks-models metrics` to list locks/hashes.
   - Export registry snapshot for change review: `jq '.' configs/model_registry.curated.json`.

---
## 6. Troubleshooting

| Symptom | Likely Cause | Resolution |
|---------|--------------|------------|
| `KeyError` when selecting | Logical name absent or filtered out. | Ensure registry entry exists and profile/test filters allow it. |
| Hash mismatch on verify | Files changed or corrupted. | Re-download assets, update expected hash if intentional change. |
| `CapabilityError` | Requested capability not present. | Amend `capabilities` map or choose different model. |
| vLLM activation fails | `backend_config.launch` incorrect or GPU busy. | Review `_staging/active_vllm.json` and service logs, adjust command. |
| GUI shows stale data | Registry cache not reloaded. | Run `load_registry(force=True)` or restart services. |

---
## 7. Integration Map

- **Chat Proxy**: uses loader on each request to validate availability and served ids.
- **Downloader**: populates `download_path`, `artifacts`, and discovered registry overlay.
- **Personal Tagger / Color Narrator**: `use_registry` flag resolves stage-specific models by `role`.
- **Image Similarity Checker**: `--use-loader` ensures explanation models align with registry naming.

---
## 8. File Locations & Logs

- `logs/model_loader.log` (if enabled via env `IMAGEWORKS_LOG_DIR`).
- `_staging/active_vllm.json` – active state persisted by `VllmManager` (shared with chat proxy).
- Cached registry stored in-memory; run `load_registry(force=True)` to invalidate.

